<!DOCTYPE html>
<html>
<head>
  <title>Testes</title>
  <script type="text/javascript" src="assets/js/fases.js"></script>
  <script type="text/javascript" src="lib/createjs-2015.05.21.min.js"></script>
</head>
<body onload="init();">

<div id="box" style="font-size:20pt;position:absolute"></div>

<canvas id="canvas" width="800" height="600" style="border: black solid 1px">
  
</canvas>

<script type="text/javascript">
  var stage, w, h;
  var manifest;

  //imagem do fundo
  var cozinha;
  var loader;

  //objetos do jogo e portas
  var objetos = [];
  var qtdObjetosPosicionados = 0;
  var portas = [];
  var faseAtual = 0; // de 0 a 17

  function init(){

    // cria a cena para guardar os objetos na tela
    stage = new createjs.Stage("canvas");
    w = stage.canvas.width;
    h = stage.canvas.height;

    manifest = [
      {src: "cozinha.jpg", id: "cozinha"},
    ];

    for (var i = 1; i <= 40; i++) {
      manifest.push({src: "objeto" + i + ".png", id: "objeto" + i});
    }

    loader = new createjs.LoadQueue(false);
    loader.addEventListener("complete", handleComplete);
    loader.loadManifest(manifest, true, "assets/images/");
  }


  function handleComplete() {
    //mostra o fundo
    cozinha = new createjs.Bitmap(loader.getResult("cozinha"));
    stage.addChild(cozinha);
    
    inicializaPortas();
    desenhaPortas();
    carregaFase(faseAtual);

    // redesenha a cena vÃ¡rias vezes por segundo
    createjs.Ticker.setFPS(60);
    createjs.Ticker.addEventListener("tick", stage);
  }

function inicializaPortas() {
  // cria as portas
  // coordenadas x e y das portas
  portasX=[40,200,500,640];
  portasY=[20,100,420,500];

  for(i = 0; i < 16 ; i++){ 
    portas[i]={
      x:portasX[i%4],
      y:portasY[Math.floor(i/4)],
      width:100,
      height:60,
      objeto: null
    };
  }
}

function desenhaPortas() {
  for(i = 0; i < 16 ; i++) { 
    //test: desenha as portas para que sejam visibles
    var porta=portas[i];
    var shape = new createjs.Shape();
    shape.graphics.beginFill("#ff0000").drawRect(porta.x,porta.y,porta.width,porta.height);
    stage.addChild(shape);
  }
}

// numFase: de 0 a 17
function carregaFase(numFase) {
  qtdObjetosPosicionados = 0;
  removeTodosOsObjetos();
  limpaTodasAsPortas();

  var indice = 0;
  for (var i = 0; i < numFase; i++) {
    indice += qtdObjetosPorFase[i] * 3;
  }

  for (var i = indice; i <= indice + 3 * (qtdObjetosPorFase[numFase] - 1); i += 3) {
    var idPorta = dadosFase[i];
    var idObjeto = dadosFase[i + 1];
    var idOutroObjeto = dadosFase[i + 2];
    
    var objeto = adicionaObjeto(idObjeto, idPorta);
    var outro = adicionaObjeto(idOutroObjeto, null);
    objetos.push(objeto);
    objetos.push(outro);
  }

  for (var i = 0; i < objetos.length; i++) {
    stage.addChild(objetos[i]);
  }
}

function limpaTodasAsPortas() {
  for (var i = 0; i < portas.length; i++) {
    portas[i].idObjeto = null;
  }
}

function removeObjeto(objeto) {
  var idObjeto = objeto.idObjeto;
  var indice = objetos.indexOf(idObjeto);
  objetos.splice(indice, 1);
  stage.removeChild(objeto);
}

function removeTodosOsObjetos() {
  for (var i = objetos.length - 1; i >= 0; i--) {
    removeObjeto(objetos[i]);
  };
}

function adicionaObjeto(idObjeto, idPorta) {
  var objeto = new createjs.Bitmap(loader.getResult("objeto" + idObjeto));
  objeto.portaCerta = idPorta;
  objeto.idPorta = null;
  objeto.idObjeto = idObjeto;
  objeto.offX = 0;
  objeto.offY = 0;
  
  objeto.scaleX = objeto.scaleY = .5;
  objeto.x = objeto.iniX = 50 + (idObjeto * 50) % 700;
  objeto.y = objeto.iniY = 200;

  objeto.on("mousedown", function(evt){
    this.parent.addChild(this);
    this.offX = this.x - evt.stageX;
    this.offY = this.y - evt.stageY;
  });

  objeto.on("pressmove", function(evt){
    stage.canvas.style.cursor = "none";
    this.x = evt.stageX + this.offX;
    this.y = evt.stageY + this.offY;
  });

  objeto.addEventListener("pressup", soltaObjeto);

  return objeto;
}

function qtdObjetosEmPortas() {
  var qtd = 0;
  for (var i = 0; i < objetos.length; i++) {
    if (objetos[i].idPorta != null) {
      qtd++;
    }
  }
  return qtd;
}

function todosOsObjetosForamPosicionados() {
  return qtdObjetosEmPortas() == qtdObjetosPorFase[faseAtual];  
}

function avancaFase() {
  faseAtual++;
  if (faseAtual <= 17) {
    carregaFase(faseAtual);
  }
}

function onObjetoPosicionado(objeto, idPorta) {
  objeto.idPorta = idPorta;
  if (idPorta != null) {
    portas[idPorta].idObjeto = objeto.idObjeto;
    if (todosOsObjetosForamPosicionados()) {
      avancaFase();
    }
  }
}

function moveObjetoParaPorta(objeto, idPorta) {
  var porta = portas[idPorta];
  var portax = porta.x + porta.width / 2;
  var portay = porta.y + porta.height / 2;

  var finalx = portax - objeto.getBounds().width * objeto.scaleX / 2;
  var finaly = portay - objeto.getBounds().height * objeto.scaleY / 2;

  createjs.Tween.get(objeto).to(
      {x: finalx,
       y: finaly},
      300,
      createjs.Ease.getPowInOut(2));

  onObjetoPosicionado(objeto, i);
}

function soltaObjeto(evt) {
  // show back the cursor
  stage.canvas.style.cursor = "auto";

  // check para ver se estou arrastrando sobre uma porta
  var match=-1;
  for(i = 0; i < 16 ; i++){
    porta = portas[i];
   
    if( getIntersection(porta,evt.target.getTransformedBounds())){
      match=i;
      break;
    }
  }
  if(match!=-1 && portas[match].idObjeto == null){
    document.getElementById('box').innerText=i;
    moveObjetoParaPorta(evt.target, match);
  }
  else {
    onObjetoPosicionado(evt.target, null);
    createjs.Tween.get(evt.target).to(
        {x: evt.target.iniX,
         y: evt.target.iniY},
        300,
        createjs.Ease.getPowInOut(2));
  }

  
}


function getIntersection(rect1,rect2) {
    if ( rect1.x >= rect2.x + rect2.width || rect1.x + rect1.width <= rect2.x || rect1.y >= rect2.y + rect2.height || rect1.y + rect1.height <= rect2.y ) return false;
    return true;
}
</script>

</body>
</html>